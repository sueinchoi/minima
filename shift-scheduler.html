---
layout: default
title: ë³‘ì› ë‹¹ì§í‘œ ìƒì„±ê¸°
---

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            color: #34495e;
            margin-top: 30px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .input-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .result-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .person-entry {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .person-entry h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 16px;
        }

        label {
            display: block;
            margin: 8px 0 4px 0;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 5px 0;
        }

        .checkbox-group label {
            display: inline-flex;
            align-items: center;
            margin: 0;
            font-weight: normal;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
            margin: 5px;
        }

        button:hover {
            background: #2980b9;
        }

        button.secondary {
            background: #95a5a6;
        }

        button.secondary:hover {
            background: #7f8c8d;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        .button-group {
            text-align: center;
            margin: 20px 0;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-day {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background: white;
            min-height: 100px;
        }

        .calendar-day.week1 { background: #fff5f5; }
        .calendar-day.week2 { background: #f5f9ff; }
        .calendar-day.week3 { background: #f5fff5; }
        .calendar-day.week4 { background: #fffef5; }

        .day-header {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e0e0e0;
        }

        .day-number {
            font-size: 18px;
            color: #3498db;
        }

        .duty-assignment {
            margin: 5px 0;
            font-size: 14px;
        }

        .duty-primary {
            color: #e74c3c;
            font-weight: 600;
        }

        .duty-secondary {
            color: #3498db;
            font-weight: 500;
        }

        .stats {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .alert-error {
            background: #fee;
            border-left: 4px solid #e74c3c;
            color: #c0392b;
        }

        .alert-success {
            background: #efe;
            border-left: 4px solid #27ae60;
            color: #229954;
        }

        .alert-info {
            background: #eff;
            border-left: 4px solid #3498db;
            color: #2471a3;
        }

        .small-text {
            font-size: 12px;
            color: #7f8c8d;
            font-style: italic;
        }

        .add-person-form {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .preference-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
        }

        .badge-2nd-preferred {
            background: #d4edda;
            color: #155724;
        }

        .badge-2nd-limited {
            background: #fff3cd;
            color: #856404;
        }

        .badge-vacation {
            background: #f8d7da;
            color: #721c24;
        }

        .vacation-indicator {
            background: #f8d7da;
            color: #721c24;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
            margin-top: 5px;
            font-weight: 600;
        }

        .vacation-form {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            border-left: 3px solid #ffc107;
        }

        .vacation-list {
            margin-top: 10px;
        }

        .vacation-item {
            background: #fff;
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .day-range-input {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 5px;
            align-items: center;
        }

        .day-range-input input {
            width: 100%;
        }

        .calendar-day.editable {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .calendar-day.editable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .calendar-day.manually-edited {
            border: 2px solid #f39c12;
            position: relative;
        }

        .manual-edit-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f39c12;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .edit-mode {
            background: #fff9e6 !important;
            border: 2px solid #3498db !important;
        }

        .edit-controls {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .edit-controls select {
            width: 100%;
            margin: 5px 0;
            padding: 5px;
            font-size: 13px;
        }

        .edit-controls button {
            padding: 5px 10px;
            font-size: 12px;
            margin: 3px;
        }
    </style>
</head>
<body>
    <h1>ğŸ¥ ë³‘ì› ë‹¹ì§í‘œ ìë™ ìƒì„±ê¸°</h1>

    <div class="container">
        <!-- Chatbot Section -->
        <div class="input-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
            <h2 style="color: white;">ğŸ’¬ ë¹ ë¥¸ ì¸ì› ì¶”ê°€ (ì±—ë´‡)</h2>
            <p style="font-size: 13px; opacity: 0.9; margin-bottom: 15px;">
                ê°„ë‹¨í•˜ê²Œ ì…ë ¥í•˜ì„¸ìš”! ìš”ì¼ë§Œ ì–¸ê¸‰í•˜ë©´ ë¶ˆê°€ëŠ¥ìœ¼ë¡œ ìë™ ì¸ì‹ë©ë‹ˆë‹¤.
            </p>

            <div id="chatHistory" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; margin-bottom: 15px; max-height: 300px; overflow-y: auto; min-height: 150px;">
                <div style="color: rgba(255,255,255,0.7); font-size: 13px; text-align: center; padding: 20px;">
                    ğŸ’¡ ì±„íŒ…ìœ¼ë¡œ ì¸ì›ì„ ì¶”ê°€í•˜ê³  ìˆ˜ì •í•˜ì„¸ìš”!<br><br>
                    <strong>ì‹ ê·œ ì¶”ê°€:</strong><br>
                    "ê¹€ì² ìˆ˜ ì›” ìˆ˜" â†’ ì›”, ìˆ˜ ë¶ˆê°€ëŠ¥<br>
                    "ì´ì˜í¬ ì›” í™” 5íšŒ" â†’ ì›”í™” ë¶ˆê°€, 5íšŒ<br><br>
                    <strong>ê¸°ì¡´ ì¸ì› ìˆ˜ì •:</strong><br>
                    "ê¹€ì² ìˆ˜ ìµœëŒ€ 8íšŒ" â†’ ìµœëŒ€ íšŸìˆ˜ ë³€ê²½<br>
                    "ì´ì˜í¬ 2ndë§Œ" â†’ 2nd duty ì„¤ì •<br>
                    "ë°•ë¯¼ìˆ˜ íœ´ê°€ 5-10" â†’ íœ´ê°€ ì¶”ê°€<br>
                    "ìµœì§„í˜¸ ì„ í˜¸ 3ì¼ ë‹¹ì§" â†’ ì„ í˜¸ì¼ ì¶”ê°€
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <input type="text" id="chatInput" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜ ì›” ìˆ˜ / ì´ì˜í¬ íœ´ê°€ 5-10 / ë°•ë¯¼ìˆ˜ ì›” í™” 5íšŒ"
                    style="flex: 1; padding: 12px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.95); border-radius: 6px;"
                    onkeypress="if(event.key==='Enter') processChatInput()">
                <button onclick="processChatInput()" style="padding: 12px 24px; background: white; color: #667eea; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    ì „ì†¡
                </button>
            </div>
        </div>

        <!-- Input Section -->
        <div class="input-section">
            <h2>ğŸ“‹ ì¸ì› ê´€ë¦¬</h2>

            <div class="add-person-form">
                <h3>ìƒˆ ì¸ì› ì¶”ê°€</h3>
                <label>ì´ë¦„</label>
                <input type="text" id="newPersonName" placeholder="ì´ë¦„ ì…ë ¥">

                <label>ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ (ë‹¹ì§)</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" value="ì›”" class="new-unavailable-day"> ì›”</label>
                    <label><input type="checkbox" value="í™”" class="new-unavailable-day"> í™”</label>
                    <label><input type="checkbox" value="ìˆ˜" class="new-unavailable-day"> ìˆ˜</label>
                    <label><input type="checkbox" value="ëª©" class="new-unavailable-day"> ëª©</label>
                    <label><input type="checkbox" value="ê¸ˆ" class="new-unavailable-day"> ê¸ˆ</label>
                </div>

                <label>ëŒ€ì²´ ê°€ëŠ¥ ìš”ì¼ (2nd dutyë¡œ ê°€ëŠ¥)</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" value="ì›”" class="new-alternative-day"> ì›”</label>
                    <label><input type="checkbox" value="í™”" class="new-alternative-day"> í™”</label>
                    <label><input type="checkbox" value="ìˆ˜" class="new-alternative-day"> ìˆ˜</label>
                    <label><input type="checkbox" value="ëª©" class="new-alternative-day"> ëª©</label>
                    <label><input type="checkbox" value="ê¸ˆ" class="new-alternative-day"> ê¸ˆ</label>
                </div>

                <label>ìµœëŒ€ ë‹¹ì§ íšŸìˆ˜</label>
                <input type="number" id="newPersonMaxDuties" value="5" min="0" max="20">

                <label>2nd Duty ì„ í˜¸ë„</label>
                <select id="newPersonSecondDutyPref">
                    <option value="normal">ì¼ë°˜</option>
                    <option value="preferred">ì„ í˜¸ (ë¬´ì œí•œ)</option>
                    <option value="limited">ì œí•œì  (1íšŒë§Œ)</option>
                    <option value="2nd-only">2nd dutyë§Œ</option>
                </select>

                <div style="margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 5px; border-left: 3px solid #3498db;">
                    <label style="font-size: 14px; font-weight: 600; color: #2c3e50;">ğŸ“… ì£¼ë³„ ì œì•½ (ì„ íƒì‚¬í•­)</label>
                    <p class="small-text" style="margin: 5px 0 10px 0;">ê° ì£¼ì°¨ë³„ë¡œ ë‹¤ë¥¸ ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                        <!-- 1ì£¼ì°¨ -->
                        <div style="background: white; padding: 10px; border-radius: 4px;">
                            <strong style="font-size: 13px; color: #e74c3c;">1ì£¼ì°¨</strong>
                            <div style="margin-top: 5px;">
                                <label style="font-size: 11px; margin: 3px 0;">ë¶ˆê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week1-unavailable"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week1-unavailable"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week1-unavailable"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week1-unavailable"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week1-unavailable"> ê¸ˆ</label>
                                </div>
                                <label style="font-size: 11px; margin: 3px 0;">2nd ê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week1-alternative"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week1-alternative"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week1-alternative"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week1-alternative"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week1-alternative"> ê¸ˆ</label>
                                </div>
                            </div>
                        </div>

                        <!-- 2ì£¼ì°¨ -->
                        <div style="background: white; padding: 10px; border-radius: 4px;">
                            <strong style="font-size: 13px; color: #3498db;">2ì£¼ì°¨</strong>
                            <div style="margin-top: 5px;">
                                <label style="font-size: 11px; margin: 3px 0;">ë¶ˆê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week2-unavailable"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week2-unavailable"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week2-unavailable"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week2-unavailable"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week2-unavailable"> ê¸ˆ</label>
                                </div>
                                <label style="font-size: 11px; margin: 3px 0;">2nd ê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week2-alternative"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week2-alternative"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week2-alternative"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week2-alternative"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week2-alternative"> ê¸ˆ</label>
                                </div>
                            </div>
                        </div>

                        <!-- 3ì£¼ì°¨ -->
                        <div style="background: white; padding: 10px; border-radius: 4px;">
                            <strong style="font-size: 13px; color: #27ae60;">3ì£¼ì°¨</strong>
                            <div style="margin-top: 5px;">
                                <label style="font-size: 11px; margin: 3px 0;">ë¶ˆê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week3-unavailable"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week3-unavailable"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week3-unavailable"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week3-unavailable"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week3-unavailable"> ê¸ˆ</label>
                                </div>
                                <label style="font-size: 11px; margin: 3px 0;">2nd ê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week3-alternative"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week3-alternative"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week3-alternative"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week3-alternative"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week3-alternative"> ê¸ˆ</label>
                                </div>
                            </div>
                        </div>

                        <!-- 4ì£¼ì°¨ -->
                        <div style="background: white; padding: 10px; border-radius: 4px;">
                            <strong style="font-size: 13px; color: #f39c12;">4ì£¼ì°¨</strong>
                            <div style="margin-top: 5px;">
                                <label style="font-size: 11px; margin: 3px 0;">ë¶ˆê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week4-unavailable"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week4-unavailable"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week4-unavailable"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week4-unavailable"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week4-unavailable"> ê¸ˆ</label>
                                </div>
                                <label style="font-size: 11px; margin: 3px 0;">2nd ê°€ëŠ¥</label>
                                <div class="checkbox-group">
                                    <label style="font-size: 12px;"><input type="checkbox" value="ì›”" class="new-week4-alternative"> ì›”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="í™”" class="new-week4-alternative"> í™”</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ìˆ˜" class="new-week4-alternative"> ìˆ˜</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ëª©" class="new-week4-alternative"> ëª©</label>
                                    <label style="font-size: 12px;"><input type="checkbox" value="ê¸ˆ" class="new-week4-alternative"> ê¸ˆ</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 15px; background: #fff3e6; border-radius: 5px; border-left: 3px solid #f39c12;">
                    <label style="font-size: 14px; font-weight: 600; color: #2c3e50;">â­ ì„ í˜¸ ë‹¹ì§ ë‚ ì§œ (ì„ íƒì‚¬í•­)</label>
                    <p class="small-text" style="margin: 5px 0 10px 0;">íŠ¹ì • ë‚ ì§œì— ë‹¹ì§ ë˜ëŠ” 2nd ë‹¹ì§ìœ¼ë¡œ ìš°ì„  ë°°ì •ë©ë‹ˆë‹¤.</p>

                    <div id="newPersonPreferredDuties" style="margin-top: 10px;">
                        <!-- Preferred duty entries will be added here -->
                    </div>

                    <button type="button" onclick="addNewPreferredDutyField()" style="padding: 5px 10px; font-size: 12px; margin-top: 10px; background: #f39c12; color: white; border: none; border-radius: 3px; cursor: pointer;">â• ì„ í˜¸ ë‚ ì§œ ì¶”ê°€</button>
                </div>

                <div style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 5px; border-left: 3px solid #27ae60;">
                    <label style="font-size: 14px; font-weight: 600; color: #2c3e50;">ğŸ–ï¸ íœ´ê°€ (ì„ íƒì‚¬í•­)</label>
                    <p class="small-text" style="margin: 5px 0 10px 0;">íœ´ê°€ ê¸°ê°„ ë™ì•ˆì€ ë‹¹ì§ ë° 2nd ë‹¹ì§ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.</p>

                    <div id="newPersonVacations" style="margin-top: 10px;">
                        <!-- Vacation entries will be added here -->
                    </div>

                    <button type="button" onclick="addNewVacationField()" style="padding: 5px 10px; font-size: 12px; margin-top: 10px; background: #27ae60; color: white; border: none; border-radius: 3px; cursor: pointer;">â• íœ´ê°€ ì¶”ê°€</button>
                </div>

                <div class="button-group">
                    <button onclick="addPerson()">â• ì¸ì› ì¶”ê°€</button>
                </div>
            </div>

            <div id="personList"></div>

            <div class="button-group">
                <button onclick="loadSampleData()">ğŸ“ ì˜ˆì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="clearAllData()" class="danger">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
            </div>
        </div>

        <!-- Result Section -->
        <div class="result-section">
            <h2>ğŸ“… ë‹¹ì§í‘œ</h2>

            <div class="button-group">
                <button onclick="generateSchedule()">ğŸ¯ ë‹¹ì§í‘œ ìƒì„±</button>
                <button onclick="generateMultipleSchedules()">ğŸ”„ ì—¬ëŸ¬ ê²½ìš° ìƒì„± (5ê°œ)</button>
                <button onclick="exportSchedule()" class="secondary">ğŸ’¾ ë‚´ë³´ë‚´ê¸°</button>
            </div>

            <div id="scheduleNavigation" style="display: none; text-align: center; margin: 15px 0; padding: 10px; background: #f0f8ff; border-radius: 5px;">
                <button onclick="previousSchedule()" class="secondary">â—€ ì´ì „</button>
                <span id="scheduleInfo" style="margin: 0 20px; font-weight: 600; color: #2c3e50;">1 / 1</span>
                <button onclick="nextSchedule()" class="secondary">ë‹¤ìŒ â–¶</button>
            </div>

            <div class="alert alert-info" style="font-size: 13px;">
                ğŸ’¡ <strong>íŒ:</strong> ë‹¹ì§í‘œ ìƒì„± í›„ ê° ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ ë‹¹ì§ìë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìˆ˜ë™ í¸ì§‘ëœ ë‚ ì§œëŠ” ì£¼í™©ìƒ‰ í…Œë‘ë¦¬ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
            </div>

            <div id="messages"></div>
            <div id="calendar"></div>
            <div id="statistics"></div>
        </div>
    </div>

    <script>
        // Global data
        let people = [];
        let schedule = null;
        let schedules = []; // Multiple schedules storage
        let currentScheduleIndex = 0; // Current schedule being viewed
        const DAYS_OF_WEEK = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
        const TOTAL_DAYS = 20;
        const WEEKS = 4;

        // Person class
        class Person {
            constructor(name, unavailableDays, alternativeDays, maxDuties, secondDutyPref, vacations, weeklyRestrictions, preferredDutyDays) {
                this.name = name;
                this.unavailableDays = unavailableDays || [];
                this.alternativeDays = alternativeDays || [];
                this.maxDuties = maxDuties || 5;
                this.secondDutyPref = secondDutyPref || 'normal'; // 'normal', 'preferred', 'limited'
                this.vacations = vacations || []; // Array of {start, end} objects
                this.weeklyRestrictions = weeklyRestrictions || {}; // {weekNum: {unavailable: [], alternative: []}}
                this.preferredDutyDays = preferredDutyDays || []; // Array of {day: number, type: 'primary' | 'secondary' | 'any'}
                this.primaryCount = 0;
                this.secondaryCount = 0;
            }

            isOnVacation(dayNumber) {
                return this.vacations.some(v => dayNumber >= v.start && dayNumber <= v.end);
            }

            hasPreferredDuty(dayNumber, type) {
                return this.preferredDutyDays.some(p =>
                    p.day === dayNumber && (type === 'any' || p.type === type || p.type === 'any')
                );
            }

            addPreferredDuty(day, type) {
                this.preferredDutyDays.push({ day, type });
            }

            removePreferredDuty(index) {
                this.preferredDutyDays.splice(index, 1);
            }

            canDoPrimaryDuty(dayOfWeek, dayNumber, weekNumber) {
                // 2nd duty only staff cannot do primary duty
                if (this.secondDutyPref === '2nd-only') return false;

                if (this.isOnVacation(dayNumber)) return false;

                // Check general unavailable days (applies to all weeks)
                if (this.unavailableDays.includes(dayOfWeek)) return false;

                // Check week-specific restrictions
                if (weekNumber && this.weeklyRestrictions[weekNumber]) {
                    const weekRestriction = this.weeklyRestrictions[weekNumber];
                    if (weekRestriction.unavailable && weekRestriction.unavailable.includes(dayOfWeek)) {
                        return false;
                    }
                }

                return true;
            }

            canDoSecondaryDuty(dayOfWeek, dayNumber, weekNumber) {
                if (this.isOnVacation(dayNumber)) return false;

                // Check week-specific restrictions first
                if (weekNumber && this.weeklyRestrictions[weekNumber]) {
                    const weekRestriction = this.weeklyRestrictions[weekNumber];
                    if (weekRestriction.unavailable && weekRestriction.unavailable.includes(dayOfWeek)) {
                        // Check if this day is in alternative list for this week
                        return weekRestriction.alternative && weekRestriction.alternative.includes(dayOfWeek);
                    }
                }

                // Check general unavailable days
                if (this.unavailableDays.includes(dayOfWeek)) {
                    return this.alternativeDays.includes(dayOfWeek);
                }

                return true;
            }

            getTotalDuties() {
                return this.primaryCount + this.secondaryCount;
            }

            canTakeMoreDuties() {
                // ABSOLUTE CONSTRAINT: Total duties (primary + secondary) must not exceed maxDuties
                // This is checked FIRST, regardless of preference
                const totalDuties = this.getTotalDuties();
                if (totalDuties >= this.maxDuties) {
                    return false; // Already at or over max limit
                }

                // For specific preferences, apply additional rules
                if (this.secondDutyPref === '2nd-only') {
                    // 2nd-only staff: secondary count should also not exceed max
                    return this.secondaryCount < this.maxDuties;
                }
                if (this.secondDutyPref === 'limited' && this.secondaryCount >= 1) {
                    // Limited: max 1 secondary, rest primary
                    return this.primaryCount < this.maxDuties;
                }

                // For 'preferred' and 'normal', just check total (already checked above)
                return true;
            }

            addVacation(start, end) {
                this.vacations.push({ start, end });
            }

            removeVacation(index) {
                this.vacations.splice(index, 1);
            }

            addWeeklyRestriction(weekNum, unavailableDays, alternativeDays) {
                this.weeklyRestrictions[weekNum] = {
                    unavailable: unavailableDays || [],
                    alternative: alternativeDays || []
                };
            }

            removeWeeklyRestriction(weekNum) {
                delete this.weeklyRestrictions[weekNum];
            }
        }

        // Load sample data
        function loadSampleData() {
            // Create person with weekly restriction example
            const kimNayoung = new Person('ê¹€ë‚˜ì˜', ['í™”', 'ëª©', 'ê¸ˆ'], [], 3, 'normal', [], {}, []);
            kimNayoung.addWeeklyRestriction(1, ['ì›”', 'ìˆ˜'], []);  // 1ì£¼ì°¨: ì›”, ìˆ˜ ë¶ˆê°€
            kimNayoung.addWeeklyRestriction(2, ['ëª©', 'ê¸ˆ'], ['ëª©']);  // 2ì£¼ì°¨: ëª©, ê¸ˆ ë¶ˆê°€ (ëª©ìš”ì¼ì€ 2nd ê°€ëŠ¥)

            people = [
                kimNayoung,
                new Person('ì´í˜„ê·œ', [], [], 20, 'preferred', [], {}, []),
                new Person('ì´ì •ìˆ˜', ['ìˆ˜', 'ëª©'], ['ìˆ˜'], 5, 'normal', [], {}, []),
                new Person('ìœ ì˜ì² ', ['ìˆ˜', 'ëª©', 'ê¸ˆ'], [], 3, 'normal', [], {}, []),
                new Person('ì„œì§€ìš°', ['ì›”', 'í™”'], ['ì›”'], 5, 'normal', [], {}, []),
                new Person('ì´ë¯¼ì •', ['í™”', 'ìˆ˜'], ['í™”'], 5, 'normal', [], {}, []),
                new Person('ê³µí¬ì •', ['ì›”', 'í™”'], ['ì›”'], 5, 'normal', [], {}, []),
                new Person('ë¬¸ì§€ì• ', ['ëª©', 'ê¸ˆ'], ['ëª©'], 5, 'normal', [], {}, []),
                new Person('ì „ë³‘ë‚¨', ['ìˆ˜', 'ëª©'], ['ìˆ˜'], 5, 'normal', [], {}, []),
                new Person('ë…¸í˜„ì •', ['í™”', 'ìˆ˜'], ['í™”'], 5, 'normal', [], {}, []),
                new Person('ë°±ì§€ì›', [], [], 5, 'limited', [], {}, []),
                new Person('ë°•ìˆ˜ì •', ['ê¸ˆ', 'ì›”'], ['ê¸ˆ'], 5, 'normal', [{start: 5, end: 12}], {}, [])
            ];
            renderPersonList();
            showMessage('ì˜ˆì‹œ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (ê¹€ë‚˜ì˜: 1ì£¼ì°¨ ì›”/ìˆ˜, 2ì£¼ì°¨ ëª©/ê¸ˆ ë¶ˆê°€)', 'success');
        }

        // Add person
        // Manage preferred duty fields in the add person form
        let newPersonPreferredDutyCounter = 0;

        function addNewPreferredDutyField() {
            const container = document.getElementById('newPersonPreferredDuties');
            const fieldId = newPersonPreferredDutyCounter++;

            const fieldHTML = `
                <div class="new-preferred-duty-field" id="newPreferredField_${fieldId}" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 10px; padding: 10px; background: white; border-radius: 4px;">
                    <div>
                        <label style="font-size: 12px; margin: 3px 0;">ë‚ ì§œ (Day)</label>
                        <input type="number" class="new-preferred-day" data-field-id="${fieldId}" min="1" max="20" placeholder="1-20" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; margin: 3px 0;">ìœ í˜•</label>
                        <select class="new-preferred-type" data-field-id="${fieldId}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <option value="any">ë‹¹ì§/2nd</option>
                            <option value="primary">ë‹¹ì§ë§Œ</option>
                            <option value="secondary">2ndë§Œ</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button type="button" onclick="removeNewPreferredDutyField(${fieldId})" style="padding: 5px 10px; font-size: 12px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">ì‚­ì œ</button>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', fieldHTML);
        }

        function removeNewPreferredDutyField(fieldId) {
            const field = document.getElementById(`newPreferredField_${fieldId}`);
            if (field) {
                field.remove();
            }
        }

        // Manage vacation fields in the add person form
        let newPersonVacationCounter = 0;

        function addNewVacationField() {
            const container = document.getElementById('newPersonVacations');
            const fieldId = newPersonVacationCounter++;

            const fieldHTML = `
                <div class="new-vacation-field" id="newVacationField_${fieldId}" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 10px; padding: 10px; background: white; border-radius: 4px;">
                    <div>
                        <label style="font-size: 12px; margin: 3px 0;">ì‹œì‘ì¼ (Day)</label>
                        <input type="number" class="new-vacation-start" data-field-id="${fieldId}" min="1" max="20" placeholder="1-20" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>
                    <div>
                        <label style="font-size: 12px; margin: 3px 0;">ì¢…ë£Œì¼ (Day)</label>
                        <input type="number" class="new-vacation-end" data-field-id="${fieldId}" min="1" max="20" placeholder="1-20" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button type="button" onclick="removeNewVacationField(${fieldId})" style="padding: 5px 10px; font-size: 12px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">ì‚­ì œ</button>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', fieldHTML);
        }

        function removeNewVacationField(fieldId) {
            const field = document.getElementById(`newVacationField_${fieldId}`);
            if (field) {
                field.remove();
            }
        }

        function addPerson() {
            const name = document.getElementById('newPersonName').value.trim();
            if (!name) {
                showMessage('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const unavailableDays = Array.from(document.querySelectorAll('.new-unavailable-day:checked'))
                .map(cb => cb.value);
            const alternativeDays = Array.from(document.querySelectorAll('.new-alternative-day:checked'))
                .map(cb => cb.value);
            const maxDuties = parseInt(document.getElementById('newPersonMaxDuties').value) || 5;
            const secondDutyPref = document.getElementById('newPersonSecondDutyPref').value;

            // Read weekly restrictions
            const weeklyRestrictions = {};
            for (let week = 1; week <= 4; week++) {
                const weekUnavailable = Array.from(document.querySelectorAll(`.new-week${week}-unavailable:checked`))
                    .map(cb => cb.value);
                const weekAlternative = Array.from(document.querySelectorAll(`.new-week${week}-alternative:checked`))
                    .map(cb => cb.value);

                // Only add if there are restrictions for this week
                if (weekUnavailable.length > 0 || weekAlternative.length > 0) {
                    weeklyRestrictions[week] = {
                        unavailable: weekUnavailable,
                        alternative: weekAlternative
                    };
                }
            }

            // Read preferred duty dates
            const preferredDutyDays = [];
            const preferredDayInputs = document.querySelectorAll('.new-preferred-day');
            const preferredTypeInputs = document.querySelectorAll('.new-preferred-type');

            for (let i = 0; i < preferredDayInputs.length; i++) {
                const day = parseInt(preferredDayInputs[i].value);
                const type = preferredTypeInputs[i].value;

                if (day && day >= 1 && day <= 20) {
                    preferredDutyDays.push({ day, type });
                }
            }

            // Read vacations
            const vacations = [];
            const vacationStartInputs = document.querySelectorAll('.new-vacation-start');
            const vacationEndInputs = document.querySelectorAll('.new-vacation-end');

            for (let i = 0; i < vacationStartInputs.length; i++) {
                const start = parseInt(vacationStartInputs[i].value);
                const end = parseInt(vacationEndInputs[i].value);

                if (start && end && start >= 1 && start <= 20 && end >= 1 && end <= 20) {
                    if (start > end) {
                        showMessage(`íœ´ê°€ ${i + 1}: ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`, 'error');
                        return;
                    }
                    vacations.push({ start, end });
                }
            }

            people.push(new Person(name, unavailableDays, alternativeDays, maxDuties, secondDutyPref, vacations, weeklyRestrictions, preferredDutyDays));

            // Clear form
            document.getElementById('newPersonName').value = '';
            document.querySelectorAll('.new-unavailable-day').forEach(cb => cb.checked = false);
            document.querySelectorAll('.new-alternative-day').forEach(cb => cb.checked = false);
            document.getElementById('newPersonMaxDuties').value = 5;
            document.getElementById('newPersonSecondDutyPref').value = 'normal';

            // Clear weekly restrictions
            for (let week = 1; week <= 4; week++) {
                document.querySelectorAll(`.new-week${week}-unavailable`).forEach(cb => cb.checked = false);
                document.querySelectorAll(`.new-week${week}-alternative`).forEach(cb => cb.checked = false);
            }

            // Clear preferred duty dates
            document.getElementById('newPersonPreferredDuties').innerHTML = '';

            // Clear vacations
            document.getElementById('newPersonVacations').innerHTML = '';

            renderPersonList();
            showMessage(`${name} ë‹˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // Chatbot functions
        function addChatMessage(text, isUser = false) {
            const chatHistory = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                margin-bottom: 10px;
                padding: 10px 15px;
                border-radius: 12px;
                max-width: 80%;
                ${isUser ? 'margin-left: auto; background: rgba(255,255,255,0.95); color: #333; text-align: right;' : 'background: rgba(255,255,255,0.2); color: white;'}
                font-size: 14px;
                line-height: 1.5;
            `;
            messageDiv.innerHTML = text;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function parseNaturalLanguage(text) {
            const result = {
                name: null,
                unavailableDays: [],
                alternativeDays: [],
                maxDuties: 5,
                secondDutyPref: 'normal',
                vacations: [],
                preferredDutyDays: [],
                action: 'add'
            };

            // Extract name - improved to handle particles properly
            // Remove common particles: ì€/ëŠ”/ì´/ê°€/ì„/ë¥¼/ì—ê²Œ/í•œí…Œ
            let nameMatch = text.match(/^([ê°€-í£]{2,})(ì€|ëŠ”|ì´|ê°€|ì„|ë¥¼|ì—ê²Œ|í•œí…Œ|ë‹˜)/);
            if (nameMatch) {
                result.name = nameMatch[1];
            } else {
                // Just get first hangul word
                nameMatch = text.match(/^([ê°€-í£]{2,})/);
                if (nameMatch) {
                    result.name = nameMatch[1];
                }
            }

            // If no name found, return early
            if (!result.name) {
                return result;
            }

            // Remove name from text for easier parsing
            const textWithoutName = text.replace(result.name, '').replace(/^(ì€|ëŠ”|ì´|ê°€|ì„|ë¥¼|ì—ê²Œ|í•œí…Œ|ë‹˜)+/, '').trim();

            // Days of week mapping
            const dayMap = {
                'ì›”': 'ì›”', 'ì›”ìš”ì¼': 'ì›”',
                'í™”': 'í™”', 'í™”ìš”ì¼': 'í™”',
                'ìˆ˜': 'ìˆ˜', 'ìˆ˜ìš”ì¼': 'ìˆ˜',
                'ëª©': 'ëª©', 'ëª©ìš”ì¼': 'ëª©',
                'ê¸ˆ': 'ê¸ˆ', 'ê¸ˆìš”ì¼': 'ê¸ˆ'
            };

            // Check for vacation with date range first
            const vacationWithDates = textWithoutName.match(/íœ´ê°€.*?(\d+).*?(\d+)|(\d+).*?(\d+).*?íœ´ê°€|(\d+)\s*[-~]\s*(\d+)/);
            if (vacationWithDates && textWithoutName.includes('íœ´ê°€')) {
                const start = parseInt(vacationWithDates[1] || vacationWithDates[3] || vacationWithDates[5]);
                const end = parseInt(vacationWithDates[2] || vacationWithDates[4] || vacationWithDates[6]);
                if (start && end && start <= end && start >= 1 && end <= 20) {
                    result.vacations.push({ start, end });
                    result.action = 'vacation';
                    return result; // Vacation request, don't parse other stuff
                }
            }

            // Extract all mentioned weekdays
            const mentionedDays = [];
            for (const [key, value] of Object.entries(dayMap)) {
                if (textWithoutName.includes(key)) {
                    if (!mentionedDays.includes(value)) {
                        mentionedDays.push(value);
                    }
                }
            }

            // Preferred duty days - check before unavailable days
            const preferredMatch = textWithoutName.match(/ì„ í˜¸.*?(\d+).*?(ë‹¹ì§|2nd)|(\d+).*?(ë‹¹ì§|2nd).*?ì„ í˜¸|(\d+)ì¼.*?(ë‹¹ì§|2nd)/);
            if (preferredMatch && (textWithoutName.includes('ì„ í˜¸') || textWithoutName.includes('ì›í•˜'))) {
                const day = parseInt(preferredMatch[1] || preferredMatch[3] || preferredMatch[5]);
                const typeText = preferredMatch[2] || preferredMatch[4] || preferredMatch[6];
                const type = typeText === '2nd' ? 'secondary' : 'primary';
                if (day >= 1 && day <= 20) {
                    result.preferredDutyDays.push({ day, type });
                    result.action = 'preferred';
                    return result;
                }
            }

            // Check if mentioned days are unavailable or alternative
            // Keywords that indicate unavailability
            const unavailableKeywords = ['ë¶ˆê°€ëŠ¥', 'ë¶ˆê°€', 'ëª»í•¨', 'ëª»í•´', 'ì•ˆë¨', 'ì•ˆë¼', 'X', 'Ã—', 'íœ´ë¬´'];
            const alternativeKeywords = ['2nd', 'ì„¸ì»¨ë“œ', 'ëŒ€ì²´'];

            const hasUnavailableKeyword = unavailableKeywords.some(kw => textWithoutName.includes(kw));

            if (mentionedDays.length > 0) {
                // If no explicit unavailable keyword but days are mentioned, assume they're unavailable
                // This handles cases like "ê¹€ì² ìˆ˜ ì›” ìˆ˜" â†’ assume unavailable
                if (hasUnavailableKeyword || !textWithoutName.match(/ê°€ëŠ¥|ì„ í˜¸|2nd|ì„¸ì»¨ë“œ/)) {
                    result.unavailableDays = [...mentionedDays];
                }

                // Check for alternative (2nd duty possible) for each day
                for (const day of mentionedDays) {
                    // Look for pattern: "ì›” 2nd", "ì›” 2nd ê°€ëŠ¥", "ì›”ìš”ì¼ ì„¸ì»¨ë“œ"
                    const dayIndex = textWithoutName.indexOf(day);
                    const afterDay = textWithoutName.substring(dayIndex);
                    const beforeNextDay = afterDay.split(/[í™”ìˆ˜ëª©ê¸ˆì›”]/)[0]; // Text until next day

                    if (alternativeKeywords.some(kw => beforeNextDay.includes(kw)) || beforeNextDay.includes('ê°€ëŠ¥')) {
                        if (!result.alternativeDays.includes(day) && result.unavailableDays.includes(day)) {
                            result.alternativeDays.push(day);
                        }
                    }
                }
            }

            // Max duties - support "ìµœëŒ€ 5íšŒ", "8íšŒ", "ìµœëŒ€ 8ë²ˆ" etc
            const maxMatch = textWithoutName.match(/(?:ìµœëŒ€\s*)?(\d+)\s*(íšŒ|ë²ˆ)/);
            if (maxMatch) {
                result.maxDuties = parseInt(maxMatch[1]);
            }

            // 2nd duty preference
            if (textWithoutName.match(/2nd\s*(ë§Œ|dutyë§Œ)|ì„¸ì»¨ë“œë§Œ/)) {
                result.secondDutyPref = '2nd-only';
            } else if (textWithoutName.match(/2nd\s*ì„ í˜¸|ì„¸ì»¨ë“œ\s*ì„ í˜¸/)) {
                result.secondDutyPref = 'preferred';
            } else if (textWithoutName.match(/ì œí•œì |2nd\s*1íšŒ/)) {
                result.secondDutyPref = 'limited';
            }

            return result;
        }

        function processChatInput() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();

            if (!text) return;

            // Clear initial message if exists
            const chatHistory = document.getElementById('chatHistory');
            if (chatHistory.children.length === 1 && chatHistory.innerHTML.includes('ì±„íŒ…ìœ¼ë¡œ ì¸ì›ì„ ì¶”ê°€í•´ë³´ì„¸ìš”')) {
                chatHistory.innerHTML = '';
            }

            // Add user message
            addChatMessage(text, true);
            input.value = '';

            // Parse input
            const parsed = parseNaturalLanguage(text);

            // Process based on action
            if (!parsed.name) {
                addChatMessage('âŒ ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜ˆ: "ê¹€ì² ìˆ˜ëŠ” ì›”ìš”ì¼ ë¶ˆê°€ëŠ¥"');
                return;
            }

            // Check if person already exists
            const existingPerson = people.find(p => p.name === parsed.name);

            if (parsed.action === 'vacation' && existingPerson) {
                // Add vacation to existing person
                if (parsed.vacations.length > 0) {
                    const vac = parsed.vacations[0];
                    existingPerson.vacations.push(vac);
                    renderPersonList();
                    addChatMessage(`âœ… ${parsed.name}ë‹˜ì˜ íœ´ê°€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (Day ${vac.start} ~ ${vac.end})`);
                }
                return;
            }

            if (parsed.action === 'preferred' && existingPerson) {
                // Add preferred duty to existing person
                if (parsed.preferredDutyDays.length > 0) {
                    const pref = parsed.preferredDutyDays[0];
                    existingPerson.preferredDutyDays.push(pref);
                    renderPersonList();
                    const typeText = pref.type === 'primary' ? 'ë‹¹ì§' : '2nd duty';
                    addChatMessage(`âœ… ${parsed.name}ë‹˜ì˜ ì„ í˜¸ ë‚ ì§œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (Day ${pref.day} ${typeText})`);
                }
                return;
            }

            if (existingPerson && parsed.action === 'add') {
                // Update existing person's information
                let updated = false;
                let updateMsg = `âœ… ${parsed.name}ë‹˜ì˜ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!<br>`;

                // Update unavailable days (if specified)
                if (parsed.unavailableDays.length > 0) {
                    // Add new unavailable days (don't replace, add to existing)
                    parsed.unavailableDays.forEach(day => {
                        if (!existingPerson.unavailableDays.includes(day)) {
                            existingPerson.unavailableDays.push(day);
                        }
                    });
                    updateMsg += `- ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ ì¶”ê°€: ${parsed.unavailableDays.join(', ')}<br>`;
                    updated = true;
                }

                // Update alternative days (if specified)
                if (parsed.alternativeDays.length > 0) {
                    parsed.alternativeDays.forEach(day => {
                        if (!existingPerson.alternativeDays.includes(day)) {
                            existingPerson.alternativeDays.push(day);
                        }
                    });
                    updateMsg += `- 2nd ê°€ëŠ¥ ì¶”ê°€: ${parsed.alternativeDays.join(', ')}<br>`;
                    updated = true;
                }

                // Update max duties (if different from default 5)
                if (parsed.maxDuties !== 5) {
                    existingPerson.maxDuties = parsed.maxDuties;
                    updateMsg += `- ìµœëŒ€ ë‹¹ì§: ${parsed.maxDuties}íšŒë¡œ ë³€ê²½<br>`;
                    updated = true;
                }

                // Update 2nd duty preference (if not normal)
                if (parsed.secondDutyPref !== 'normal') {
                    existingPerson.secondDutyPref = parsed.secondDutyPref;
                    const prefText = parsed.secondDutyPref === '2nd-only' ? '2ndë§Œ' :
                                    parsed.secondDutyPref === 'preferred' ? '2nd ì„ í˜¸' : 'ì œí•œì ';
                    updateMsg += `- 2nd Duty: ${prefText}ìœ¼ë¡œ ë³€ê²½<br>`;
                    updated = true;
                }

                if (updated) {
                    renderPersonList();
                    addChatMessage(updateMsg);
                } else {
                    addChatMessage(`â„¹ï¸ ${parsed.name}ë‹˜ì€ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì—…ë°ì´íŠ¸í•  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>ì˜ˆ: "${parsed.name} ìµœëŒ€ 8íšŒ", "${parsed.name} 2ndë§Œ"`);
                }
                return;
            }

            // Add new person
            const newPerson = new Person(
                parsed.name,
                parsed.unavailableDays,
                parsed.alternativeDays,
                parsed.maxDuties,
                parsed.secondDutyPref,
                parsed.vacations,
                {},
                parsed.preferredDutyDays
            );

            people.push(newPerson);
            renderPersonList();

            // Build confirmation message
            let confirmMsg = `âœ… ${parsed.name}ë‹˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!<br>`;
            if (parsed.unavailableDays.length > 0) {
                confirmMsg += `- ë¶ˆê°€ëŠ¥í•œ ìš”ì¼: ${parsed.unavailableDays.join(', ')}<br>`;
            }
            if (parsed.alternativeDays.length > 0) {
                confirmMsg += `- 2nd ê°€ëŠ¥: ${parsed.alternativeDays.join(', ')}<br>`;
            }
            confirmMsg += `- ìµœëŒ€ ë‹¹ì§: ${parsed.maxDuties}íšŒ<br>`;
            if (parsed.secondDutyPref !== 'normal') {
                const prefText = parsed.secondDutyPref === '2nd-only' ? '2ndë§Œ' :
                                parsed.secondDutyPref === 'preferred' ? '2nd ì„ í˜¸' : 'ì œí•œì ';
                confirmMsg += `- 2nd Duty: ${prefText}<br>`;
            }
            if (parsed.vacations.length > 0) {
                parsed.vacations.forEach(v => {
                    confirmMsg += `- íœ´ê°€: Day ${v.start} ~ ${v.end}<br>`;
                });
            }
            if (parsed.preferredDutyDays.length > 0) {
                parsed.preferredDutyDays.forEach(p => {
                    const typeText = p.type === 'primary' ? 'ë‹¹ì§' : '2nd duty';
                    confirmMsg += `- ì„ í˜¸: Day ${p.day} ${typeText}<br>`;
                });
            }

            addChatMessage(confirmMsg);
        }

        // Remove person
        function removePerson(index) {
            const person = people[index];
            if (confirm(`${person.name} ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                people.splice(index, 1);
                renderPersonList();
                showMessage('ì¸ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('ëª¨ë“  ì¸ì› ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                people = [];
                schedule = null;
                renderPersonList();
                document.getElementById('calendar').innerHTML = '';
                document.getElementById('statistics').innerHTML = '';
                showMessage('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }
        }

        // Render person list
        function renderPersonList() {
            const listDiv = document.getElementById('personList');
            if (people.length === 0) {
                listDiv.innerHTML = '<p class="small-text">ë“±ë¡ëœ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¸ì›ì„ ì¶”ê°€í•˜ê±°ë‚˜ ì˜ˆì‹œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>';
                return;
            }

            let html = '<h3>ë“±ë¡ëœ ì¸ì› (' + people.length + 'ëª…)</h3>';
            people.forEach((person, index) => {
                let badge = '';
                if (person.secondDutyPref === 'preferred') {
                    badge = '<span class="preference-badge badge-2nd-preferred">2nd ì„ í˜¸</span>';
                } else if (person.secondDutyPref === 'limited') {
                    badge = '<span class="preference-badge badge-2nd-limited">2nd 1íšŒë§Œ</span>';
                } else if (person.secondDutyPref === '2nd-only') {
                    badge = '<span class="preference-badge badge-vacation">2ndë§Œ</span>';
                }

                let vacationHTML = '';
                if (person.vacations && person.vacations.length > 0) {
                    vacationHTML = '<div class="vacation-list">';
                    person.vacations.forEach((vacation, vIdx) => {
                        vacationHTML += `
                            <div class="vacation-item">
                                <span>ğŸ–ï¸ Day ${vacation.start} ~ ${vacation.end}</span>
                                <button class="danger btn-remove-vacation" data-person-index="${index}" data-vacation-index="${vIdx}" style="padding: 3px 8px; font-size: 12px;">ì‚­ì œ</button>
                            </div>
                        `;
                    });
                    vacationHTML += '</div>';
                }

                // Weekly restrictions display and form
                let weeklyHTML = '';
                if (person.weeklyRestrictions && Object.keys(person.weeklyRestrictions).length > 0) {
                    weeklyHTML = '<div class="vacation-list" style="margin-top: 10px;">';
                    Object.keys(person.weeklyRestrictions).sort().forEach(weekNum => {
                        const restriction = person.weeklyRestrictions[weekNum];
                        const unavailText = restriction.unavailable && restriction.unavailable.length > 0
                            ? restriction.unavailable.join(', ') : 'ì—†ìŒ';
                        const altText = restriction.alternative && restriction.alternative.length > 0
                            ? `, 2nd ê°€ëŠ¥: ${restriction.alternative.join(', ')}` : '';
                        weeklyHTML += `
                            <div class="vacation-item">
                                <span>ğŸ“… ${weekNum}ì£¼ì°¨: ${unavailText}${altText}</span>
                                <button class="danger btn-remove-weekly" data-person-index="${index}" data-week-num="${weekNum}" style="padding: 3px 8px; font-size: 12px;">ì‚­ì œ</button>
                            </div>
                        `;
                    });
                    weeklyHTML += '</div>';
                }

                // Preferred duty days display
                let preferredHTML = '';
                if (person.preferredDutyDays && person.preferredDutyDays.length > 0) {
                    preferredHTML = '<div class="vacation-list" style="margin-top: 10px;">';
                    person.preferredDutyDays.forEach((pref, pIdx) => {
                        let typeText = '';
                        if (pref.type === 'primary') typeText = 'ë‹¹ì§';
                        else if (pref.type === 'secondary') typeText = '2nd duty';
                        else typeText = 'ë‹¹ì§/2nd';
                        preferredHTML += `
                            <div class="vacation-item">
                                <span>â­ Day ${pref.day}: ${typeText}</span>
                                <button class="danger btn-remove-preferred" data-person-index="${index}" data-preferred-index="${pIdx}" style="padding: 3px 8px; font-size: 12px;">ì‚­ì œ</button>
                            </div>
                        `;
                    });
                    preferredHTML += '</div>';
                }

                html += `
                    <div class="person-entry">
                        <h3>${person.name}${badge}</h3>
                        <p class="small-text">
                            <strong>ë‹¹ì§ ë¶ˆê°€ (ì „ì²´):</strong> ${person.unavailableDays.join(', ') || 'ì—†ìŒ'}<br>
                            <strong>2nd ê°€ëŠ¥ (ì „ì²´):</strong> ${person.alternativeDays.join(', ') || 'í•´ë‹¹ì—†ìŒ'}<br>
                            <strong>ìµœëŒ€ íšŸìˆ˜:</strong> ${person.maxDuties}íšŒ
                        </p>
                        ${weeklyHTML}
                        ${vacationHTML}
                        ${preferredHTML}

                        <div class="vacation-form" style="background: #e8f4f8;">
                            <label style="font-size: 13px; margin-bottom: 5px;">ì£¼ë³„ ì œì•½ ì¶”ê°€</label>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: start;">
                                <div>
                                    <label style="font-size: 12px;">ì£¼ì°¨</label>
                                    <select id="weekNum_${index}" style="width: 60px; padding: 5px; font-size: 13px;">
                                        <option value="1">1ì£¼</option>
                                        <option value="2">2ì£¼</option>
                                        <option value="3">3ì£¼</option>
                                        <option value="4">4ì£¼</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 12px;">ë¶ˆê°€ëŠ¥í•œ ìš”ì¼</label>
                                    <div class="checkbox-group" style="margin-bottom: 5px;">
                                        <label><input type="checkbox" value="ì›”" class="week-unavailable-${index}"> ì›”</label>
                                        <label><input type="checkbox" value="í™”" class="week-unavailable-${index}"> í™”</label>
                                        <label><input type="checkbox" value="ìˆ˜" class="week-unavailable-${index}"> ìˆ˜</label>
                                        <label><input type="checkbox" value="ëª©" class="week-unavailable-${index}"> ëª©</label>
                                        <label><input type="checkbox" value="ê¸ˆ" class="week-unavailable-${index}"> ê¸ˆ</label>
                                    </div>
                                    <label style="font-size: 12px;">2nd duty ê°€ëŠ¥</label>
                                    <div class="checkbox-group">
                                        <label><input type="checkbox" value="ì›”" class="week-alternative-${index}"> ì›”</label>
                                        <label><input type="checkbox" value="í™”" class="week-alternative-${index}"> í™”</label>
                                        <label><input type="checkbox" value="ìˆ˜" class="week-alternative-${index}"> ìˆ˜</label>
                                        <label><input type="checkbox" value="ëª©" class="week-alternative-${index}"> ëª©</label>
                                        <label><input type="checkbox" value="ê¸ˆ" class="week-alternative-${index}"> ê¸ˆ</label>
                                    </div>
                                </div>
                            </div>
                            <button class="btn-add-weekly" data-person-index="${index}" style="padding: 6px 12px; font-size: 13px; margin-top: 5px;">ì£¼ë³„ ì œì•½ ì¶”ê°€</button>
                        </div>

                        <div class="vacation-form">
                            <label style="font-size: 13px; margin-bottom: 5px;">íœ´ê°€ ì¶”ê°€</label>
                            <div class="day-range-input">
                                <input type="number" id="vacStart_${index}" min="1" max="20" placeholder="ì‹œì‘ì¼">
                                <span>~</span>
                                <input type="number" id="vacEnd_${index}" min="1" max="20" placeholder="ì¢…ë£Œì¼">
                            </div>
                            <button class="btn-add-vacation" data-person-index="${index}" style="padding: 6px 12px; font-size: 13px; margin-top: 5px;">íœ´ê°€ ì¶”ê°€</button>
                        </div>

                        <div class="vacation-form" style="background: #fff3e6;">
                            <label style="font-size: 13px; margin-bottom: 5px;">ì„ í˜¸ ë‹¹ì§ ë‚ ì§œ ì¶”ê°€</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <label style="font-size: 12px; margin: 3px 0;">ë‚ ì§œ (Day)</label>
                                    <input type="number" id="prefDay_${index}" min="1" max="20" placeholder="1-20" style="width: 100%; padding: 5px;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; margin: 3px 0;">ìœ í˜•</label>
                                    <select id="prefType_${index}" style="width: 100%; padding: 5px;">
                                        <option value="any">ë‹¹ì§/2nd</option>
                                        <option value="primary">ë‹¹ì§ë§Œ</option>
                                        <option value="secondary">2ndë§Œ</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn-add-preferred" data-person-index="${index}" style="padding: 6px 12px; font-size: 13px; margin-top: 5px;">ì„ í˜¸ ë‚ ì§œ ì¶”ê°€</button>
                        </div>

                        <button class="danger btn-remove-person" data-person-index="${index}" style="padding: 6px 12px; font-size: 14px; margin-top: 10px;">ì¸ì› ì‚­ì œ</button>
                    </div>
                `;
            });
            listDiv.innerHTML = html;
        }

        // Add weekly restriction
        function addWeeklyRestriction(personIndex) {
            const weekNum = parseInt(document.getElementById(`weekNum_${personIndex}`).value);
            const unavailableDays = Array.from(document.querySelectorAll(`.week-unavailable-${personIndex}:checked`))
                .map(cb => cb.value);
            const alternativeDays = Array.from(document.querySelectorAll(`.week-alternative-${personIndex}:checked`))
                .map(cb => cb.value);

            if (unavailableDays.length === 0) {
                showMessage('ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            people[personIndex].addWeeklyRestriction(weekNum, unavailableDays, alternativeDays);
            renderPersonList();
            showMessage(`${people[personIndex].name}ì˜ ${weekNum}ì£¼ì°¨ ì œì•½ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // Remove weekly restriction
        function removeWeeklyRestriction(personIndex, weekNum) {
            const person = people[personIndex];
            if (!person || !person.weeklyRestrictions || !person.weeklyRestrictions[weekNum]) {
                showMessage('ì‚­ì œ ì˜¤ë¥˜: í•´ë‹¹ ì£¼ì°¨ ì œì•½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            if (confirm(`${person.name}ì˜ ${weekNum}ì£¼ì°¨ ì œì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                delete person.weeklyRestrictions[weekNum];
                renderPersonList();
                showMessage('ì£¼ë³„ ì œì•½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // Add vacation
        function addVacation(personIndex) {
            const startInput = document.getElementById(`vacStart_${personIndex}`);
            const endInput = document.getElementById(`vacEnd_${personIndex}`);

            const start = parseInt(startInput.value);
            const end = parseInt(endInput.value);

            if (!start || !end) {
                showMessage('íœ´ê°€ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (start < 1 || start > 20 || end < 1 || end > 20) {
                showMessage('DayëŠ” 1ë¶€í„° 20 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (start > end) {
                showMessage('ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            people[personIndex].addVacation(start, end);
            renderPersonList();
            showMessage(`${people[personIndex].name}ì˜ íœ´ê°€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (Day ${start} ~ ${end})`, 'success');
        }

        // Remove vacation
        function removeVacation(personIndex, vacationIndex) {
            const person = people[personIndex];
            if (!person || !person.vacations || !person.vacations[vacationIndex]) {
                showMessage('ì‚­ì œ ì˜¤ë¥˜: íœ´ê°€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const vacation = person.vacations[vacationIndex];
            if (confirm(`${person.name}ì˜ íœ´ê°€ (Day ${vacation.start} ~ ${vacation.end})ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                person.vacations.splice(vacationIndex, 1);
                renderPersonList();
                showMessage('íœ´ê°€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // Add preferred duty day
        function addPreferredDuty(personIndex) {
            const dayInput = document.getElementById(`prefDay_${personIndex}`);
            const typeInput = document.getElementById(`prefType_${personIndex}`);

            const day = parseInt(dayInput.value);
            const type = typeInput.value;

            if (!day || day < 1 || day > 20) {
                showMessage('DayëŠ” 1ë¶€í„° 20 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            people[personIndex].addPreferredDuty(day, type);
            dayInput.value = '';
            typeInput.value = 'any';
            renderPersonList();
            showMessage(`${people[personIndex].name}ì˜ ì„ í˜¸ ë‹¹ì§ ë‚ ì§œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (Day ${day})`, 'success');
        }

        // Remove preferred duty day
        function removePreferredDuty(personIndex, preferredIndex) {
            const person = people[personIndex];
            if (!person || !person.preferredDutyDays || !person.preferredDutyDays[preferredIndex]) {
                showMessage('ì‚­ì œ ì˜¤ë¥˜: ì„ í˜¸ ë‹¹ì§ ë‚ ì§œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const pref = person.preferredDutyDays[preferredIndex];
            let typeText = pref.type === 'primary' ? 'ë‹¹ì§' : pref.type === 'secondary' ? '2nd duty' : 'ë‹¹ì§/2nd';
            if (confirm(`${person.name}ì˜ ì„ í˜¸ ë‹¹ì§ (Day ${pref.day}: ${typeText})ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                person.preferredDutyDays.splice(preferredIndex, 1);
                renderPersonList();
                showMessage('ì„ í˜¸ ë‹¹ì§ ë‚ ì§œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // Generate schedule
        function generateSchedule() {
            if (people.length === 0) {
                showMessage('ì¸ì›ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // Reset counts
            people.forEach(p => {
                p.primaryCount = 0;
                p.secondaryCount = 0;
            });

            schedule = [];
            const assignments = [];

            // Try to generate schedule
            let success = true;
            let attempts = 0;
            const maxAttempts = 100;
            let failureReason = '';
            let failureDay = 0;

            while (attempts < maxAttempts) {
                attempts++;
                schedule = [];
                people.forEach(p => {
                    p.primaryCount = 0;
                    p.secondaryCount = 0;
                });

                success = true;
                failureReason = '';

                for (let day = 0; day < TOTAL_DAYS; day++) {
                    const week = Math.floor(day / 5);
                    const weekNumber = week + 1;
                    const dayOfWeek = DAYS_OF_WEEK[day % 5];
                    const dayNumber = day + 1;

                    // Find primary duty - check for preferred duty first
                    let primary = null;
                    // For preferred duty, MUST check max duties (absolute constraint) and vacation
                    const preferredPrimaryPeople = people.filter(p =>
                        p.hasPreferredDuty(dayNumber, 'primary') &&
                        !p.isOnVacation(dayNumber) &&
                        p.canTakeMoreDuties() // ABSOLUTE: must respect max duties
                    );

                    // Debug logging
                    if (preferredPrimaryPeople.length > 0) {
                        console.log(`âœ… Day ${dayNumber}: Found ${preferredPrimaryPeople.length} people with preferred primary duty:`, preferredPrimaryPeople.map(p => p.name), '(max duties checked)');
                    }

                    if (preferredPrimaryPeople.length > 0) {
                        primary = preferredPrimaryPeople[0];
                        console.log(`âœ… Day ${dayNumber}: Assigned preferred primary duty to ${primary.name}`);
                    } else {
                        const primaryCandidates = people.filter(p =>
                            p.canDoPrimaryDuty(dayOfWeek, dayNumber, weekNumber) &&
                            p.canTakeMoreDuties() &&
                            !isConsecutive(schedule, p.name, day)
                        ).sort((a, b) => {
                            // If same maxDuties, balance total duties within the group
                            if (a.maxDuties === b.maxDuties) {
                                return a.getTotalDuties() - b.getTotalDuties();
                            }
                            // Otherwise compare by primary count
                            return a.primaryCount - b.primaryCount;
                        });

                        if (primaryCandidates.length === 0) {
                            success = false;
                            failureDay = dayNumber;
                            failureReason = `Day ${dayNumber} (${dayOfWeek}, ${weekNumber}ì£¼ì°¨): ë‹¹ì§ì„ ë°°ì •í•  ìˆ˜ ìˆëŠ” ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤. ë¶ˆê°€ëŠ¥í•œ ìš”ì¼, íœ´ê°€, ìµœëŒ€ ë‹¹ì§ íšŸìˆ˜, ì—°ì† ë‹¹ì§ ë“±ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`;
                            break;
                        }

                        primary = primaryCandidates[0];
                    }

                    if (!primary) {
                        success = false;
                        if (!failureReason) {
                            failureDay = dayNumber;
                            failureReason = `Day ${dayNumber} (${dayOfWeek}, ${weekNumber}ì£¼ì°¨): ë‹¹ì§ì„ ë°°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                        }
                        break;
                    }

                    // Find secondary duty - check for preferred duty first
                    let secondary = null;
                    // For preferred duty, MUST check max duties (absolute constraint) and vacation
                    const preferredSecondaryPeople = people.filter(p =>
                        p !== primary &&
                        p.hasPreferredDuty(dayNumber, 'secondary') &&
                        !p.isOnVacation(dayNumber) &&
                        p.canTakeMoreDuties() // ABSOLUTE: must respect max duties
                    );

                    // Debug logging
                    if (preferredSecondaryPeople.length > 0) {
                        console.log(`âœ… Day ${dayNumber}: Found ${preferredSecondaryPeople.length} people with preferred secondary duty:`, preferredSecondaryPeople.map(p => p.name), '(max duties checked)');
                    }

                    if (preferredSecondaryPeople.length > 0) {
                        secondary = preferredSecondaryPeople[0];
                        console.log(`âœ… Day ${dayNumber}: Assigned preferred secondary duty to ${secondary.name}`);
                    } else {
                        const secondaryCandidates = people.filter(p =>
                            p !== primary &&
                            p.canDoSecondaryDuty(dayOfWeek, dayNumber, weekNumber) &&
                            (p.secondDutyPref === 'preferred' ||
                             (p.secondDutyPref === '2nd-only' && p.canTakeMoreDuties()) ||
                             (p.secondDutyPref === 'limited' && p.secondaryCount < 1) ||
                             (p.secondDutyPref === 'normal' && p.canTakeMoreDuties())) &&
                            !isConsecutive(schedule, p.name, day)
                        ).sort((a, b) => {
                            // Prefer people who prefer 2nd duty or are 2nd-only
                            if (a.secondDutyPref === 'preferred' && b.secondDutyPref !== 'preferred') return -1;
                            if (b.secondDutyPref === 'preferred' && a.secondDutyPref !== 'preferred') return 1;
                            if (a.secondDutyPref === '2nd-only' && b.secondDutyPref !== '2nd-only' && b.secondDutyPref !== 'preferred') return -1;
                            if (b.secondDutyPref === '2nd-only' && a.secondDutyPref !== '2nd-only' && a.secondDutyPref !== 'preferred') return 1;

                            // If same maxDuties, balance total duties within the group
                            if (a.maxDuties === b.maxDuties) {
                                return a.getTotalDuties() - b.getTotalDuties();
                            }
                            return a.secondaryCount - b.secondaryCount;
                        });

                        if (secondaryCandidates.length === 0) {
                            success = false;
                            failureDay = dayNumber;
                            failureReason = `Day ${dayNumber} (${dayOfWeek}, ${weekNumber}ì£¼ì°¨): 2nd ë‹¹ì§ì„ ë°°ì •í•  ìˆ˜ ìˆëŠ” ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤. 2nd Duty ì„ í˜¸ë„, ë¶ˆê°€ëŠ¥í•œ ìš”ì¼, íœ´ê°€, ìµœëŒ€ ë‹¹ì§ íšŸìˆ˜ ë“±ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`;
                            break;
                        }

                        secondary = secondaryCandidates[0];
                    }

                    if (!secondary) {
                        success = false;
                        if (!failureReason) {
                            failureDay = dayNumber;
                            failureReason = `Day ${dayNumber} (${dayOfWeek}, ${weekNumber}ì£¼ì°¨): 2nd ë‹¹ì§ì„ ë°°ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                        }
                        break;
                    }

                    schedule.push({
                        day: dayNumber,
                        week: weekNumber,
                        dayOfWeek: dayOfWeek,
                        primary: primary.name,
                        secondary: secondary.name
                    });

                    primary.primaryCount++;
                    secondary.secondaryCount++;
                }

                if (success) break;
            }

            if (!success) {
                let errorMsg = 'ë‹¹ì§í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n';
                if (failureReason) {
                    errorMsg += `âŒ ${failureReason}\n\n`;
                }
                errorMsg += `ğŸ’¡ í•´ê²° ë°©ë²•:\n`;
                errorMsg += `- ìµœëŒ€ ë‹¹ì§ íšŸìˆ˜ë¥¼ ëŠ˜ë ¤ì£¼ì„¸ìš”\n`;
                errorMsg += `- ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ ìˆ˜ë¥¼ ì¤„ì—¬ì£¼ì„¸ìš”\n`;
                errorMsg += `- ì¸ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”\n`;
                errorMsg += `- íœ´ê°€ ê¸°ê°„ì„ ì¡°ì •í•´ì£¼ì„¸ìš”\n\n`;
                errorMsg += `(${attempts}ë²ˆ ì‹œë„)`;

                alert(errorMsg);
                showMessage('ë‹¹ì§í‘œ ìƒì„± ì‹¤íŒ¨', 'error');
                return;
            }

            showMessage(`ë‹¹ì§í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (${attempts}ë²ˆ ì‹œë„)`, 'success');
            schedules = [schedule];
            currentScheduleIndex = 0;
            document.getElementById('scheduleNavigation').style.display = 'none';
            renderCalendar();
            renderStatistics();
        }

        // Generate multiple schedules
        function generateMultipleSchedules() {
            if (people.length === 0) {
                showMessage('ì¸ì›ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const targetCount = 5;
            schedules = [];
            const maxTotalAttempts = 500;
            let totalAttempts = 0;

            showMessage('ì—¬ëŸ¬ ê²½ìš°ì˜ ë‹¹ì§í‘œë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', 'info');

            while (schedules.length < targetCount && totalAttempts < maxTotalAttempts) {
                totalAttempts++;

                // Reset counts
                people.forEach(p => {
                    p.primaryCount = 0;
                    p.secondaryCount = 0;
                });

                let tempSchedule = [];
                let success = true;

                for (let day = 0; day < TOTAL_DAYS; day++) {
                    const week = Math.floor(day / 5);
                    const weekNumber = week + 1;
                    const dayOfWeek = DAYS_OF_WEEK[day % 5];
                    const dayNumber = day + 1;

                    // Find primary duty - check for preferred duty first
                    let primary = null;
                    // For preferred duty, MUST check max duties (absolute constraint) and vacation
                    const preferredPrimaryPeople = people.filter(p =>
                        p.hasPreferredDuty(dayNumber, 'primary') &&
                        !p.isOnVacation(dayNumber) &&
                        p.canTakeMoreDuties() // ABSOLUTE: must respect max duties
                    );

                    if (preferredPrimaryPeople.length > 0) {
                        primary = preferredPrimaryPeople[0];
                    } else {
                        // Find primary duty with randomization
                        const primaryCandidates = people.filter(p =>
                            p.canDoPrimaryDuty(dayOfWeek, dayNumber, weekNumber) &&
                            p.canTakeMoreDuties() &&
                            !isConsecutive(tempSchedule, p.name, day)
                        ).sort((a, b) => {
                            // If same maxDuties, balance total duties within the group
                            if (a.maxDuties === b.maxDuties) {
                                return a.getTotalDuties() - b.getTotalDuties();
                            }
                            // Otherwise compare by primary count
                            return a.primaryCount - b.primaryCount;
                        });

                        if (primaryCandidates.length === 0) {
                            success = false;
                            break;
                        }

                        // Randomly select from candidates with lowest total duties in same maxDuties group
                        const firstCandidate = primaryCandidates[0];
                        const bestCandidates = primaryCandidates.filter(p =>
                            p.maxDuties === firstCandidate.maxDuties &&
                            p.getTotalDuties() === firstCandidate.getTotalDuties()
                        );
                        primary = bestCandidates[Math.floor(Math.random() * bestCandidates.length)];
                    }

                    if (!primary) {
                        success = false;
                        break;
                    }

                    // Find secondary duty - check for preferred duty first
                    let secondary = null;
                    // For preferred duty, MUST check max duties (absolute constraint) and vacation
                    const preferredSecondaryPeople = people.filter(p =>
                        p !== primary &&
                        p.hasPreferredDuty(dayNumber, 'secondary') &&
                        !p.isOnVacation(dayNumber) &&
                        p.canTakeMoreDuties() // ABSOLUTE: must respect max duties
                    );

                    if (preferredSecondaryPeople.length > 0) {
                        secondary = preferredSecondaryPeople[0];
                    } else {
                        // Find secondary duty with randomization
                        const secondaryCandidates = people.filter(p =>
                            p !== primary &&
                            p.canDoSecondaryDuty(dayOfWeek, dayNumber, weekNumber) &&
                            (p.secondDutyPref === 'preferred' ||
                             (p.secondDutyPref === '2nd-only' && p.canTakeMoreDuties()) ||
                             (p.secondDutyPref === 'limited' && p.secondaryCount < 1) ||
                             (p.secondDutyPref === 'normal' && p.canTakeMoreDuties())) &&
                            !isConsecutive(tempSchedule, p.name, day)
                        ).sort((a, b) => {
                            // Prefer people who prefer 2nd duty or are 2nd-only
                            if (a.secondDutyPref === 'preferred' && b.secondDutyPref !== 'preferred') return -1;
                            if (b.secondDutyPref === 'preferred' && a.secondDutyPref !== 'preferred') return 1;
                            if (a.secondDutyPref === '2nd-only' && b.secondDutyPref !== '2nd-only' && b.secondDutyPref !== 'preferred') return -1;
                            if (b.secondDutyPref === '2nd-only' && a.secondDutyPref !== '2nd-only' && a.secondDutyPref !== 'preferred') return 1;

                            // If same maxDuties, balance total duties within the group
                            if (a.maxDuties === b.maxDuties) {
                                return a.getTotalDuties() - b.getTotalDuties();
                            }
                            return a.secondaryCount - b.secondaryCount;
                        });

                        if (secondaryCandidates.length === 0) {
                            success = false;
                            break;
                        }

                        // Randomly select from top candidates
                        const topCandidates = secondaryCandidates.slice(0, Math.min(3, secondaryCandidates.length));
                        secondary = topCandidates[Math.floor(Math.random() * topCandidates.length)];
                    }

                    if (!secondary) {
                        success = false;
                        break;
                    }

                    tempSchedule.push({
                        day: dayNumber,
                        week: weekNumber,
                        dayOfWeek: dayOfWeek,
                        primary: primary.name,
                        secondary: secondary.name
                    });

                    primary.primaryCount++;
                    secondary.secondaryCount++;
                }

                if (success && !isDuplicateSchedule(tempSchedule, schedules)) {
                    schedules.push(JSON.parse(JSON.stringify(tempSchedule)));
                }
            }

            if (schedules.length === 0) {
                let errorMsg = 'ë‹¹ì§í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n';
                errorMsg += `âŒ ${totalAttempts}ë²ˆ ì‹œë„í–ˆì§€ë§Œ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ë‹¹ì§í‘œë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\n`;
                errorMsg += `ğŸ’¡ í•´ê²° ë°©ë²•:\n`;
                errorMsg += `- ìµœëŒ€ ë‹¹ì§ íšŸìˆ˜ë¥¼ ëŠ˜ë ¤ì£¼ì„¸ìš”\n`;
                errorMsg += `- ë¶ˆê°€ëŠ¥í•œ ìš”ì¼ ìˆ˜ë¥¼ ì¤„ì—¬ì£¼ì„¸ìš”\n`;
                errorMsg += `- ì¸ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”\n`;
                errorMsg += `- íœ´ê°€ ê¸°ê°„ì„ ì¡°ì •í•´ì£¼ì„¸ìš”\n`;
                errorMsg += `- ì£¼ë³„ ì œì•½ ì¡°ê±´ì„ ì™„í™”í•´ì£¼ì„¸ìš”`;

                alert(errorMsg);
                showMessage('ë‹¹ì§í‘œ ìƒì„± ì‹¤íŒ¨', 'error');
                return;
            }

            currentScheduleIndex = 0;
            schedule = schedules[currentScheduleIndex];

            // Recalculate counts for display
            recalculateCounts();

            showMessage(`${schedules.length}ê°œì˜ ë‹¤ë¥¸ ë‹¹ì§í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (ì´ ${totalAttempts}ë²ˆ ì‹œë„)`, 'success');
            document.getElementById('scheduleNavigation').style.display = 'block';
            updateScheduleInfo();
            renderCalendar();
            renderStatistics();
        }

        // Check if schedule is duplicate
        function isDuplicateSchedule(newSchedule, existingSchedules) {
            return existingSchedules.some(existing => {
                return existing.every((day, index) =>
                    day.primary === newSchedule[index].primary &&
                    day.secondary === newSchedule[index].secondary
                );
            });
        }

        // Navigate to previous schedule
        function previousSchedule() {
            if (schedules.length === 0) return;
            currentScheduleIndex = (currentScheduleIndex - 1 + schedules.length) % schedules.length;
            schedule = schedules[currentScheduleIndex];
            recalculateCounts();
            updateScheduleInfo();
            renderCalendar();
            renderStatistics();
        }

        // Navigate to next schedule
        function nextSchedule() {
            if (schedules.length === 0) return;
            currentScheduleIndex = (currentScheduleIndex + 1) % schedules.length;
            schedule = schedules[currentScheduleIndex];
            recalculateCounts();
            updateScheduleInfo();
            renderCalendar();
            renderStatistics();
        }

        // Update schedule navigation info
        function updateScheduleInfo() {
            const info = document.getElementById('scheduleInfo');
            info.textContent = `${currentScheduleIndex + 1} / ${schedules.length}`;
        }

        // Check if assignment would be consecutive
        function isConsecutive(schedule, personName, currentDay) {
            if (currentDay === 0) return false;

            const previousDay = schedule[currentDay - 1];
            if (!previousDay) return false;

            return previousDay.primary === personName || previousDay.secondary === personName;
        }

        // Current editing day
        let editingDayIndex = null;

        // Render calendar
        function renderCalendar() {
            const calendarDiv = document.getElementById('calendar');
            if (!schedule || schedule.length === 0) {
                calendarDiv.innerHTML = '';
                return;
            }

            let html = '<div class="calendar">';
            schedule.forEach((day, index) => {
                // Check who is on vacation this day
                const vacationers = people.filter(p => p.isOnVacation(day.day))
                    .map(p => p.name);

                let vacationHTML = '';
                if (vacationers.length > 0) {
                    vacationHTML = `<div class="vacation-indicator">ğŸ–ï¸ ${vacationers.join(', ')}</div>`;
                }

                const isEditing = editingDayIndex === index;
                const editableClass = 'editable';
                const manuallyEditedClass = day.manuallyEdited ? 'manually-edited' : '';
                const editModeClass = isEditing ? 'edit-mode' : '';
                const manualBadge = day.manuallyEdited ? '<div class="manual-edit-badge">ìˆ˜ì •ë¨</div>' : '';

                let contentHTML = '';
                if (isEditing) {
                    // Edit mode
                    contentHTML = `
                        <div class="day-header">
                            <span class="day-number">Day ${day.day}</span> ${day.dayOfWeek}ìš”ì¼
                        </div>
                        <div class="edit-controls">
                            <label style="font-size: 12px; margin: 0;">ë‹¹ì§ (Primary)</label>
                            <select id="editPrimary_${index}">
                                ${people.map(p => `<option value="${p.name}" ${p.name === day.primary ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                            <label style="font-size: 12px; margin: 0;">2nd Duty</label>
                            <select id="editSecondary_${index}">
                                ${people.map(p => `<option value="${p.name}" ${p.name === day.secondary ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                            <div>
                                <button onclick="saveEdit(${index})" style="background: #27ae60;">ì €ì¥</button>
                                <button onclick="cancelEdit()" class="secondary">ì·¨ì†Œ</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Display mode
                    contentHTML = `
                        <div class="day-header">
                            <span class="day-number">Day ${day.day}</span> ${day.dayOfWeek}ìš”ì¼
                        </div>
                        <div class="duty-assignment">
                            <div class="duty-primary">ğŸ”´ ${day.primary}</div>
                            <div class="duty-secondary">ğŸ”µ ${day.secondary}</div>
                        </div>
                        ${vacationHTML}
                    `;
                }

                html += `
                    <div class="calendar-day week${day.week} ${editableClass} ${manuallyEditedClass} ${editModeClass}"
                         onclick="${isEditing ? '' : `editDay(${index})`}">
                        ${manualBadge}
                        ${contentHTML}
                    </div>
                `;
            });
            html += '</div>';
            calendarDiv.innerHTML = html;
        }

        // Edit day
        function editDay(dayIndex) {
            if (editingDayIndex !== null) {
                cancelEdit();
            }
            editingDayIndex = dayIndex;
            renderCalendar();
        }

        // Cancel edit
        function cancelEdit() {
            editingDayIndex = null;
            renderCalendar();
        }

        // Save edit
        function saveEdit(dayIndex) {
            const primarySelect = document.getElementById(`editPrimary_${dayIndex}`);
            const secondarySelect = document.getElementById(`editSecondary_${dayIndex}`);

            const newPrimary = primarySelect.value;
            const newSecondary = secondarySelect.value;

            if (newPrimary === newSecondary) {
                showMessage('ë‹¹ì§ê³¼ 2nd dutyëŠ” ê°™ì€ ì‚¬ëŒì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const day = schedule[dayIndex];
            const dayOfWeek = day.dayOfWeek;
            const dayNumber = day.day;
            const weekNumber = day.week;

            // Find person objects
            const primaryPerson = people.find(p => p.name === newPrimary);
            const secondaryPerson = people.find(p => p.name === newSecondary);

            // Validate primary duty assignment
            if (primaryPerson) {
                if (!primaryPerson.canDoPrimaryDuty(dayOfWeek, dayNumber, weekNumber)) {
                    let reason = '';
                    if (primaryPerson.isOnVacation(dayNumber)) {
                        reason = `íœ´ê°€ ì¤‘ì…ë‹ˆë‹¤ (Day ${dayNumber}).`;
                    } else if (primaryPerson.secondDutyPref === '2nd-only') {
                        reason = '2nd dutyë§Œ ê°€ëŠ¥í•œ ì‚¬ëŒì…ë‹ˆë‹¤.';
                    } else if (primaryPerson.weeklyRestrictions[weekNumber] &&
                               primaryPerson.weeklyRestrictions[weekNumber].unavailable &&
                               primaryPerson.weeklyRestrictions[weekNumber].unavailable.includes(dayOfWeek)) {
                        reason = `${weekNumber}ì£¼ì°¨ ${dayOfWeek}ìš”ì¼ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.`;
                    } else if (primaryPerson.unavailableDays.includes(dayOfWeek)) {
                        reason = `${dayOfWeek}ìš”ì¼ì€ ë‹¹ì§ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.`;
                    }

                    if (!confirm(`âš ï¸ ${newPrimary}ë‹˜ì„ Day ${dayNumber} (${dayOfWeek}ìš”ì¼) ë‹¹ì§ìœ¼ë¡œ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê²½ê³ : ${reason}\n\nê·¸ë˜ë„ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        return;
                    }
                }
            }

            // Validate secondary duty assignment
            if (secondaryPerson) {
                if (!secondaryPerson.canDoSecondaryDuty(dayOfWeek, dayNumber, weekNumber)) {
                    let reason = '';
                    if (secondaryPerson.isOnVacation(dayNumber)) {
                        reason = `íœ´ê°€ ì¤‘ì…ë‹ˆë‹¤ (Day ${dayNumber}).`;
                    } else if (secondaryPerson.weeklyRestrictions[weekNumber] &&
                               secondaryPerson.weeklyRestrictions[weekNumber].unavailable &&
                               secondaryPerson.weeklyRestrictions[weekNumber].unavailable.includes(dayOfWeek)) {
                        const alternativeAllowed = secondaryPerson.weeklyRestrictions[weekNumber].alternative &&
                                                  secondaryPerson.weeklyRestrictions[weekNumber].alternative.includes(dayOfWeek);
                        if (!alternativeAllowed) {
                            reason = `${weekNumber}ì£¼ì°¨ ${dayOfWeek}ìš”ì¼ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤ (2nd dutyë„ ë¶ˆê°€).`;
                        }
                    } else if (secondaryPerson.unavailableDays.includes(dayOfWeek)) {
                        const alternativeAllowed = secondaryPerson.alternativeDays.includes(dayOfWeek);
                        if (!alternativeAllowed) {
                            reason = `${dayOfWeek}ìš”ì¼ì€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤ (2nd dutyë„ ë¶ˆê°€).`;
                        }
                    }

                    if (reason && !confirm(`âš ï¸ ${newSecondary}ë‹˜ì„ Day ${dayNumber} (${dayOfWeek}ìš”ì¼) 2nd dutyë¡œ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê²½ê³ : ${reason}\n\nê·¸ë˜ë„ ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        return;
                    }
                }
            }

            const oldPrimary = day.primary;
            const oldSecondary = day.secondary;

            // Update schedule
            day.primary = newPrimary;
            day.secondary = newSecondary;
            day.manuallyEdited = true;

            // Recalculate counts
            recalculateCounts();

            editingDayIndex = null;
            renderCalendar();
            renderStatistics();
            showMessage(`Day ${day.day} ë‹¹ì§ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        // Recalculate duty counts
        function recalculateCounts() {
            // Reset all counts
            people.forEach(p => {
                p.primaryCount = 0;
                p.secondaryCount = 0;
            });

            // Count from schedule
            schedule.forEach(day => {
                const primaryPerson = people.find(p => p.name === day.primary);
                const secondaryPerson = people.find(p => p.name === day.secondary);

                if (primaryPerson) primaryPerson.primaryCount++;
                if (secondaryPerson) secondaryPerson.secondaryCount++;
            });
        }

        // Render statistics
        function renderStatistics() {
            const statsDiv = document.getElementById('statistics');
            if (!schedule || schedule.length === 0) {
                statsDiv.innerHTML = '';
                return;
            }

            let html = '<div class="stats"><h3>ğŸ“Š í†µê³„</h3><div class="stats-grid">';
            people.forEach(person => {
                const total = person.primaryCount + person.secondaryCount;
                const isOverMax = total > person.maxDuties;
                const totalColor = isOverMax ? 'color: #e74c3c; font-weight: bold;' : '';
                const warningIcon = isOverMax ? ' âš ï¸' : '';

                html += `
                    <div class="stat-item" style="${isOverMax ? 'border: 2px solid #e74c3c; background: #ffe6e6;' : ''}">
                        <strong>${person.name}</strong> (ìµœëŒ€: ${person.maxDuties}íšŒ)${warningIcon}<br>
                        <span class="small-text">
                            ë‹¹ì§: ${person.primaryCount}íšŒ |
                            2nd: ${person.secondaryCount}íšŒ |
                            <span style="${totalColor}">ì´: ${total}íšŒ</span>
                        </span>
                    </div>
                `;
            });
            html += '</div></div>';
            statsDiv.innerHTML = html;
        }

        // Show message
        function showMessage(msg, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const alertClass = type === 'error' ? 'alert-error' :
                              type === 'success' ? 'alert-success' : 'alert-info';
            messagesDiv.innerHTML = `<div class="alert ${alertClass}">${msg}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // Export schedule
        function exportSchedule() {
            if (!schedule || schedule.length === 0) {
                showMessage('ë¨¼ì € ë‹¹ì§í‘œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            let text = 'ë³‘ì› ë‹¹ì§í‘œ\n\n';

            // Schedule
            schedule.forEach(day => {
                const vacationers = people.filter(p => p.isOnVacation(day.day)).map(p => p.name);
                let vacInfo = vacationers.length > 0 ? ` (íœ´ê°€: ${vacationers.join(', ')})` : '';
                let editInfo = day.manuallyEdited ? ' [ìˆ˜ë™í¸ì§‘]' : '';
                text += `Day ${day.day} (${day.dayOfWeek}): ë‹¹ì§ ${day.primary}, 2nd ${day.secondary}${vacInfo}${editInfo}\n`;
            });

            // Statistics
            text += '\ní†µê³„:\n';
            people.forEach(person => {
                let vacText = '';
                if (person.vacations && person.vacations.length > 0) {
                    const vacList = person.vacations.map(v => `Day ${v.start}-${v.end}`).join(', ');
                    vacText = ` (íœ´ê°€: ${vacList})`;
                }

                let weeklyText = '';
                if (person.weeklyRestrictions && Object.keys(person.weeklyRestrictions).length > 0) {
                    const weeklyList = Object.keys(person.weeklyRestrictions).sort().map(weekNum => {
                        const r = person.weeklyRestrictions[weekNum];
                        const unavail = r.unavailable && r.unavailable.length > 0 ? r.unavailable.join(',') : '';
                        const alt = r.alternative && r.alternative.length > 0 ? `(2nd:${r.alternative.join(',')})` : '';
                        return `${weekNum}ì£¼:${unavail}${alt}`;
                    }).join(', ');
                    weeklyText = ` (ì£¼ë³„ì œì•½: ${weeklyList})`;
                }

                text += `${person.name}: ë‹¹ì§ ${person.primaryCount}íšŒ, 2nd ${person.secondaryCount}íšŒ, ì´ ${person.getTotalDuties()}íšŒ${vacText}${weeklyText}\n`;
            });

            // Manual edits summary
            const manualEdits = schedule.filter(d => d.manuallyEdited);
            if (manualEdits.length > 0) {
                text += '\nìˆ˜ë™ í¸ì§‘ëœ ë‚ ì§œ:\n';
                manualEdits.forEach(day => {
                    text += `- Day ${day.day} (${day.dayOfWeek})\n`;
                });
            }

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ë‹¹ì§í‘œ_' + new Date().toISOString().slice(0, 10) + '.txt';
            a.click();
            URL.revokeObjectURL(url);

            showMessage('ë‹¹ì§í‘œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // Initialize
        renderPersonList();

        // Event delegation for dynamically created buttons
        document.getElementById('personList').addEventListener('click', function(e) {
            // Check if clicked element or its parent is a button
            let btn = e.target.closest('button');
            if (!btn) return;

            console.log('Button clicked:', btn.className);

            // Remove vacation button
            if (btn.classList.contains('btn-remove-vacation')) {
                e.preventDefault();
                e.stopPropagation();
                const personIndex = parseInt(btn.getAttribute('data-person-index'));
                const vacationIndex = parseInt(btn.getAttribute('data-vacation-index'));
                console.log('Remove vacation:', personIndex, vacationIndex);
                removeVacation(personIndex, vacationIndex);
                return;
            }

            // Remove weekly restriction button
            if (btn.classList.contains('btn-remove-weekly')) {
                e.preventDefault();
                e.stopPropagation();
                const personIndex = parseInt(btn.getAttribute('data-person-index'));
                const weekNum = btn.getAttribute('data-week-num');
                removeWeeklyRestriction(personIndex, weekNum);
                return;
            }

            // Remove person button
            if (btn.classList.contains('btn-remove-person')) {
                e.preventDefault();
                e.stopPropagation();
                const personIndex = parseInt(btn.getAttribute('data-person-index'));
                console.log('Remove person:', personIndex);
                removePerson(personIndex);
                return;
            }

            // Add vacation button
            if (btn.classList.contains('btn-add-vacation')) {
                e.preventDefault();
                e.stopPropagation();
                const personIndex = parseInt(btn.getAttribute('data-person-index'));
                addVacation(personIndex);
                return;
            }

            // Add weekly restriction button
            if (btn.classList.contains('btn-add-weekly')) {
                e.preventDefault();
                e.stopPropagation();
                const personIndex = parseInt(btn.getAttribute('data-person-index'));
                addWeeklyRestriction(personIndex);
                return;
            }

            // Add preferred duty button
            if (btn.classList.contains('btn-add-preferred')) {
                e.preventDefault();
                e.stopPropagation();
                const personIndex = parseInt(btn.getAttribute('data-person-index'));
                addPreferredDuty(personIndex);
                return;
            }

            // Remove preferred duty button
            if (btn.classList.contains('btn-remove-preferred')) {
                e.preventDefault();
                e.stopPropagation();
                const personIndex = parseInt(btn.getAttribute('data-person-index'));
                const preferredIndex = parseInt(btn.getAttribute('data-preferred-index'));
                removePreferredDuty(personIndex, preferredIndex);
                return;
            }
        });
    </script>
</body>
</html>
